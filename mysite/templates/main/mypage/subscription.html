{% extends 'main/mypage.html' %}
{% load static %}

{% block mypageHead %}
<link rel="stylesheet" type="text/css" href="{% static 'css/mypage/subscribe.css' %}">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
{% endblock %}


{% block mypageContent %}
<div class="info-container">
    <h1>구독정보</h1>

    <div class="subscription_info">
        <h2>{{info.status}}</h2>
        <p>{{info.startDate}} ~ {{info.endDate}}</p>
    </div>

    <div class="subscribe-change">
    <a href="/subscribe/" class="">변경</a>
    </div>

    구독 원두
    {% if guide == 1 %}
    <div class="coffee_info">
    아직 구독한 원두가 없습니다.
    </div>
    {% endif %}

    {% if guide == 0 %}
    <div class="coffee_info", id="coffee-box">
        {% if alert == '1' %}
            <p class="alert-message">구독 원두 수량을 초과했습니다.<p>
        {% endif %}
        <div class="coffee-content">
            {% for item in coffee %}
            <div class="coffee-item">
                <a href="/coffee/{{item.CoffeeID}}"><img class="coffee-img" src="/static/coffee_img/{{item.CoffeeID}}.jpg"></a>
                <h3>{{item.CoffeeName}}</h3>
                <a href="{% url 'main:subscribe_remove' item.CoffeeID %}" class="custom_a">
                    <span class="material-symbols-outlined">delete</span>
                </a>&nbsp;
            </div>
            {% endfor %}
            <div class="coffee-item">
                <h3>?</h3>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="deliever-btn">
        <div class="alert alert-warning alert-dismissible fade show alert-hidden" role="alert" >
            <div id="alertPlaceholder"></div>
            <button type="button" class="btn-close" aria-label="Close"></button>
        </div>
        <button class="deliever-button">원두 배송받기</button>
    </div>
    

    구독 히스토리<br>
    {% if info.ordered == '1' %}
        주문날짜: {{info.orderDate}}
        {% for item in coffee %}
            <br>{{item.CoffeeName}} 
        {% endfor %}
    {% endif %}
</div>

<script src="https://code.jquery.com/jquery-3.4.1.js"></script>
<script>
    const alert = document.querySelector('.alert')
    
    $(document).ready(function() {
        $('.deliever-button').click(function() {
            var coffeeCount = $('.coffee-item').length;
            if ({{info.ordered}} == '1') {
                navEl.classList.add('navbar-scrolled');
                $('#alertPlaceholder').text('이번달 배송이 완료되었습니다.');
            } else if (coffeeCount == 4) {
                $.ajax({
                    headers: { "X-CSRFToken": '{{csrf_token}}' },
                    url: '{% url 'main:subscribe' %}',
                    type: 'POST',
                    data: {'ordered': 1},
                    dataType: 'json'
                  });
                console.log('Value sent successfully');
                window.location.href = '/mypage/subscribe/';
            } else {
                alert.classList.remove('alert-hidden');
                $('#alertPlaceholder').text('원두 개수가 부족합니다');
            }
        });

        $('.btn-close').click(function() {
            alert.classList.add('alert-hidden');
        });
    });
</script>
{% endblock %}